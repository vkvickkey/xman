import React, { useEffect, useRef, useState } from "react";
import { Link, Navigate, json, useNavigate } from "react-router-dom";

const logo = "/logo3.jpg";
import axios from "axios";
import Loading from "./Loading";
import Dropdown from "react-dropdown";
import "react-dropdown/style.css";
import "./style.css";
const wavs = "/wavs.gif";
const wait = "/wait.gif";
import {
  animate,
  circIn,
  circInOut,
  circOut,
  easeIn,
  easeInOut,
  easeOut,
  motion,
} from "framer-motion";
import { useAnimate, stagger } from "framer-motion";
import { Bounce, Expo, Power4, Sine } from "gsap/all";
import { Circ } from "gsap/all";
import toast, { Toaster } from "react-hot-toast";
import handleGenerateAudio from "./../utils/audioUtils";
import handleGenerateAudio2 from "./../utils/audioUtils2";
import { getArtistMetadata } from "../utils/artistUtils";
import { removeSourceAttribution, getAlbumFromTitle } from "../utils/stringUtils";
import useDragScroll from "../utils/useDragScroll";
import { getApiUrl } from "../apiConfig";

// Static playlist configuration removed



// Component for individual Fresh Hits Row to handle its own scroll ref


const ScrollButtons = ({ scrollRef }) => {
  const scroll = (offset) => {
    if (scrollRef.current) {
      scrollRef.current.scrollBy({ left: offset, behavior: "smooth" });
    }
  };
  return (
    <>
      <div onClick={() => scroll(-400)} className="z-10 absolute left-2 top-1/2 transform -translate-y-1/2 flex items-center justify-center w-10 h-10 rounded-full bg-black/50 hover:bg-black/80 backdrop-blur-sm cursor-pointer transition-all duration-300 opacity-0 group-hover:opacity-100">
        <i className="ri-arrow-left-s-line text-white text-2xl"></i>
      </div>
      <div onClick={() => scroll(400)} className="z-10 absolute right-2 top-1/2 transform -translate-y-1/2 flex items-center justify-center w-10 h-10 rounded-full bg-black/50 hover:bg-black/80 backdrop-blur-sm cursor-pointer transition-all duration-300 opacity-0 group-hover:opacity-100">
        <i className="ri-arrow-right-s-line text-white text-2xl"></i>
      </div>
    </>
  );
};

const FreshHitRow = ({ language, data, navigate, onRefresh }) => {
  const scrollRef = useRef(null);
  useDragScroll(scrollRef, data);


  if (!data || data.length === 0) return null;

  const languageDisplayMap = {
    Tamil: "‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç",
    Hindi: "‡§π‡§ø‡§Ç‡§¶‡•Ä",
    English: "English",
    Telugu: "‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å",
    Malayalam: "‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç",
  };

  return (
    <div className="fresh-hits w-full flex flex-col gap-3 ">
      <div className="relative w-full py-3 px-6 mb-2 flex items-center justify-between rounded-3xl bg-white/5 backdrop-blur-2xl border-t border-l border-r border-white/10 border-b-0 shadow-xl overflow-hidden shrink-0 group">
        <div className="absolute bottom-0 left-0 w-full h-[2px] bg-gradient-to-r from-[#8A2BE2] via-[#BF40FF] to-[#8A2BE2] blur-[1px] shadow-[0_0_20px_rgba(191,64,255,0.6)]"></div>
        <div className="flex items-center justify-center w-10 h-10 rounded-full bg-black/20 border border-white/5 backdrop-blur-md shadow-[inset_0_1px_4px_rgba(255,255,255,0.1)] cursor-pointer hover:bg-white/10 hover:scale-105 transition-all duration-300">
          <i className="ri-music-fill text-white text-xl"></i>
        </div>
        <h3 className="text-2xl font-bold text-white/90 tracking-wide capitalize drop-shadow-lg font-sans">
          Fresh Hits
        </h3>
        <div onClick={() => onRefresh(language)} className="flex items-center justify-center w-10 h-10 rounded-full bg-black/20 border border-white/5 backdrop-blur-md shadow-[inset_0_1px_4px_rgba(255,255,255,0.1)] cursor-pointer hover:bg-white/10 hover:scale-105 transition-all duration-300">
          <i className="ri-refresh-line text-white text-xl"></i>
        </div>
      </div>
      <div className="relative group w-full">
        <ScrollButtons scrollRef={scrollRef} />
        <div ref={scrollRef} className="freshhitsdata custom-scrollbar px-5 sm:px-3 flex flex-shrink gap-5 overflow-x-auto w-full pb-4">
          {data.map((f, i) => (
            <motion.div
              initial={{ y: -100, scale: 0.5 }}
              whileInView={{ y: 0, scale: 1 }}
              transition={{ ease: Circ.easeIn, duration: 0.05 }}
              onClick={() => navigate(`/playlist/details/${f.id}`)}
              key={i}
              className="hover:scale-110 sm:hover:scale-105 duration-300 flex-shrink-0 w-[15%] sm:w-[40%] rounded-md flex flex-col gap-2 py-4 cursor-pointer"
            >
              <img
                className="w-full rounded-md"
                src={f.image?.[2]?.link || f.image?.[2]?.url || f.image?.[0]?.link || f.image?.[0]?.url}
                alt=""
              />
              <motion.h3 className="leading-none">
                {removeSourceAttribution(f.name)}
              </motion.h3>
            </motion.div>
          ))}
        </div>
      </div>
    </div>
  );
};

const Home = () => {
  let navigate = useNavigate();
  const [home, sethome] = useState(null);
  const [language, setlanguage] = useState(localStorage.getItem("language") || "Tamil");
  const [details, setdetails] = useState([]);
  const [songlink, setsonglink] = useState([]);
  const [songlink2, setsonglink2] = useState([]);
  // const [songlinkchecker, setsonglinkchecker] = useState(null);
  const [like, setlike] = useState(false);
  var [index, setindex] = useState("");
  var [index2, setindex2] = useState("");
  var [page, setpage] = useState(1);
  var [page2, setpage2] = useState(Math.floor(Math.random() * 50));
  const audioRef = useRef();
  const [audiocheck, setaudiocheck] = useState(true);
  // const [selectedSongIds, setSelectedSongIds] = useState([]);
  const [suggSong, setsuggSong] = useState([]);
  const [freshHitsData, setFreshHitsData] = useState([]);
  const [bestOf90s, setBestOf90s] = useState([]);

  const [indiaSuperhitsTop50, setIndiaSuperhitsTop50] = useState([]);

  const freshHitsLanguages = ["Tamil", "Hindi", "English", "Telugu", "Malayalam"];

  // Refs for horizontal scrolling
  const detailsRef = useRef(null);
  const suggRef = useRef(null);
  const chartsRef = useRef(null);
  const playlistsRef = useRef(null);
  const albumsRef = useRef(null);
  // const freshHitsRef = useRef(null); // Removed single ref
  const bestOf90sRef = useRef(null);
  const indiaSuperhitsTop50Ref = useRef(null);

  // Initialize scroll hooks with dependencies
  useDragScroll(detailsRef, details);
  useDragScroll(suggRef, suggSong);
  useDragScroll(chartsRef, home);
  useDragScroll(playlistsRef, home);
  useDragScroll(albumsRef, home);
  useDragScroll(bestOf90sRef, bestOf90s);
  useDragScroll(indiaSuperhitsTop50Ref, indiaSuperhitsTop50);


  const options = [
    // "hindi",
    // "english",
    // "punjabi",
    // "tamil",
    // "telugu",
    // "marathi",
    // "gujarati",
    // "bengali",
    // "kannada",
    // "bhojpuri",
    // "malayalam",
    // "urdu",
    // "haryanvi",
    // "rajasthani",
    // "odia",
    // "assamese",
    "Tamil",
    "Malayalam",
    "English",
    "Telugu",
    "Hindi",
    // "punjabi",
    // "hindi",
    // "marathi",
    // "gujarati",
    // "bengali",
    // "kannada",
    // "bhojpuri",
    // "urdu",
    // "haryanvi",
    // "rajasthani",
    // "odia",
    // "assamese",
  ];


  const Gethome = async () => {
    detailsseter();
    try {
      const [trendingSongsRes, trendingAlbumsRes, chartsRes, playlistsRes, albumsRes] = await Promise.all([
        axios.get(getApiUrl("search", `/search/songs?query=Trending ${language}&limit=10`)),
        axios.get(getApiUrl("search", `/search/albums?query=Trending ${language}&limit=10`)),
        axios.get(getApiUrl("search", `/search/playlists?query=Top ${language}&limit=10`)),
        axios.get(getApiUrl("search", `/search/playlists?query=${language} Hits&limit=10`)),
        axios.get(getApiUrl("search", `/search/albums?query=Latest ${language}&limit=10`))
      ]);

      const mapItems = (items) => items ? items.map(item => ({
        id: item.id,
        name: item.name,
        title: item.title || item.name,
        subtitle: item.subtitle || item.description || "",
        type: item.type,
        image: item.image ? item.image.map(img => ({ ...img, link: img.url })) : [],
        url: item.url,
        songs: item.songs || []
      })) : [];

      const homeData = {
        charts: mapItems(chartsRes.data.data.results),
        albums: mapItems(albumsRes.data.data.results),
        playlists: mapItems(playlistsRes.data.data.results),
        trending: {
          songs: mapItems(trendingSongsRes.data.data.results),
          albums: mapItems(trendingAlbumsRes.data.data.results)
        }
      };

      sethome(homeData);
    } catch (error) {
      console.log("Error fetching home data:", error);
    }
  };


  const GetBestOf90s = async () => {
    try {
      const query = `Best of 90s ${language}`;
      const { data } = await axios.get(
        getApiUrl("search", `/search/playlists?query=${encodeURIComponent(query)}&limit=20`)
      );
      setBestOf90s(data?.data?.results || []);
    } catch (error) {
      console.error("Error fetching Best of 90s:", error);
    }
  };




  const GetIndiaSuperhitsTop50 = async () => {
    if (language !== "Tamil") {
      setIndiaSuperhitsTop50([]);
      return;
    }
    try {
      let query = "";
      // specific queries based on language as requested
      if (language === "Tamil") {
        query = "India Superhits Top 50";
      } else if (language === "Telugu") {
        query = "India Superhits Top 50 -";
      } else if (language === "Malayalam") {
        query = "India Superhits Top 50";
      } else if (language === "Hindi") {
        query = "India Superhits Top 50";
      } else if (language === "Haryanvi") {
        query = "India Superhits Top 50";
      } else if (language === "English" || language === "International") {
        query = "India Superhits Top 50";
      } else {
        // Default fallback
        query = `India Superhits Top 50 ${language}`;
      }

      const { data } = await axios.get(
        getApiUrl("search", `/search/playlists?query=${encodeURIComponent(query)}&limit=20`)
      );
      setIndiaSuperhitsTop50(data?.data?.results || []);
    } catch (error) {
      console.error("Error fetching India Superhits Top 50:", error);
    }
  };

  const GetFreshHits = async () => {
    if (language !== "Tamil") {
      setFreshHitsData([]);
      return;
    }
    try {
      // IDs provided by user
      const ids = ["10763385", "146675675", "85481065", "6689255", "2912846", "976143557", "218822376",];
      const promises = ids.map(async (id) => {
        try {
          const { data } = await axios.get(
            getApiUrl("search", `/playlists?id=${id}`)
          );
          return data.data; // The API returns the playlist object directly in data.data
        } catch (err) {
          console.error(`Error fetching fresh hit playlist ${id}:`, err);
          return null;
        }
      });

      const results = await Promise.all(promises);
      // Filter out any nulls from failed requests
      const validResults = results.filter(item => item !== null);

      setFreshHitsData(validResults);

    } catch (error) {
      console.error("Error fetching fresh hits:", error);
    }
  };
  const GetLanguageSongs = async (overridePage) => {
    try {
      // Use sequential page number
      const queryPage = overridePage || page;

      const { data } = await axios.get(
        getApiUrl("search", `/search/songs?query=${language.toLowerCase()}&page=${queryPage}&limit=20`)
      );

      setdetails((prevDetails) => {
        // Filter out duplicates
        const results = data?.data?.results || [];
        const newData = results.filter(
          (newItem) => !prevDetails.some((prevItem) => prevItem.id === newItem.id)
        );
        return [...prevDetails, ...newData];
      });
    } catch (error) {
      console.log("Error fetching language songs:", error);
    }
  };

  const Getdetails = async (overridePage) => {
    try {
      let queryPage;
      if (overridePage) {
        queryPage = overridePage;
      } else {
        // For other languages, keep using random page (page2)
        // English is now handled by GetLanguageSongs, so we can default to page2 here for others
        queryPage = page2;
      }

      const { data } = await axios.get(
        getApiUrl("search", `/search/songs?query=${language.toLowerCase()}&page=${queryPage}&limit=20`)
      );

      setdetails((prevDetails) => {
        const newData = data.data.results.filter(
          (newItem) => !prevDetails.some((prevItem) => prevItem.id === newItem.id)
        );
        return [...prevDetails, ...newData];
      });
    } catch (error) {
      console.log("error", error);
    }
  };

  const handleAiShuffle = () => {
    const randomPage = Math.floor(Math.random() * 50) + 1;
    toast(`AI Shuffling ${language} Songs! üé≤‚ú®`, {
      icon: "ü§ñ",
      style: {
        borderRadius: "10px",
        background: "linear-gradient(to right, #8A2BE2, #BF40FF)",
        color: "#fff",
      },
    });

    setdetails([]);
    setpage(randomPage);
    setpage2(randomPage);

    Getdetails(randomPage);
  };

  const refreshHomeData = async () => {
    try {
      toast.success("Refreshing Charts & Albums...");
      const [trendingSongsRes, trendingAlbumsRes, chartsRes, playlistsRes, albumsRes] = await Promise.all([
        axios.get(getApiUrl("search", `/search/songs?query=Trending ${language}&limit=10`)),
        axios.get(getApiUrl("search", `/search/albums?query=Trending ${language}&limit=10`)),
        axios.get(getApiUrl("search", `/search/playlists?query=Top ${language}&limit=10`)),
        axios.get(getApiUrl("search", `/search/playlists?query=${language} Hits&limit=10`)),
        axios.get(getApiUrl("search", `/search/albums?query=Latest ${language}&limit=10`))
      ]);

      const mapItems = (items) => items ? items.map(item => ({
        id: item.id,
        name: item.name,
        title: item.title || item.name,
        subtitle: item.subtitle || item.description || "",
        type: item.type,
        image: item.image ? item.image.map(img => ({ ...img, link: img.url })) : [],
        url: item.url,
        songs: item.songs || []
      })) : [];

      const homeData = {
        charts: mapItems(chartsRes.data.data.results),
        albums: mapItems(albumsRes.data.data.results),
        playlists: mapItems(playlistsRes.data.data.results),
        trending: {
          songs: mapItems(trendingSongsRes.data.data.results),
          albums: mapItems(trendingAlbumsRes.data.data.results)
        }
      };

      sethome(homeData);
      toast.success("Refreshed!");
    } catch (error) {
      console.log("error", error);
      toast.error("Failed to refresh.");
    }
  };

  const refreshSuggestions = () => {
    setsuggSong([]);
    processLikedSongIds();
    toast.success("Refreshing suggestions...");
  };


  const Getartists = async () => {
    // If home is already being fetched, this might be redundant, 
    // but defining it resolves the undefined error.
    try {
      if (home === null) {
        await Gethome();
      }
    } catch (error) {
      console.log("error", error);
    }
  };

  function audioseter(i) {
    if (songlink[0]?.id === details[i].id) {
      const audio = audioRef.current;
      if (!audio.paused) {
        audio.pause();
        setaudiocheck(false);
      } else {
        setaudiocheck(true);
        audio.play().catch((error) => {
          console.error("Playback failed:", error);
        });
      }
    } else {
      setindex2(null);
      setsonglink2([]);
      setindex(i);
      setsonglink([details[i]]);
    }
  }

  function audioseter2(i) {
    if (songlink2[0]?.id === suggSong[i].id) {
      const audio = audioRef.current;
      if (!audio.paused) {
        audio.pause();
        setaudiocheck(false);
      } else {
        setaudiocheck(true);
        audio.play().catch((error) => {
          console.error("Playback failed:", error);
        });
      }
    } else {
      setindex(null);
      setsonglink([]);
      setindex2(i);
      setsonglink2([suggSong[i]]);
    }
  }


  // Function to get a random subset of IDs without duplicates
  function getRandomIds(ids, num) {
    let shuffled = ids.sort(() => 0.5 - Math.random()); // Shuffle the array
    return shuffled.slice(0, num); // Return a subset of the shuffled array
  }

  // Main function to handle liked song IDs
  function processLikedSongIds() {
    // Get liked songs from localStorage
    const likedSongs = JSON.parse(localStorage.getItem("likeData")) || [];

    // Extract song IDs
    const songIds = likedSongs.map((song) => song.id);

    // Remove duplicates by converting to Set and back to Array
    const uniqueSongIds = Array.from(new Set(songIds));

    let selectedIds;

    if (uniqueSongIds.length <= 10) {
      // If less than or equal to 10 liked songs, select all IDs
      selectedIds = uniqueSongIds;
    } else {
      // If more than 10 liked songs, randomly select 10 IDs
      selectedIds = getRandomIds(uniqueSongIds, 10);
    }

    // Store selected IDs back to localStorage
    localStorage.setItem("selectedSongIds", JSON.stringify(selectedIds));
    fetchAllSongs();
    return selectedIds;
  }

  // // Function to handle fetching data for all IDs
  // const fetchAllSongs = async () => {
  //   const storedSelectedSongIds =
  //     JSON.parse(localStorage.getItem("selectedSongIds")) || [];
  //   console.log(storedSelectedSongIds);
  //   // const fetchedSongs = [];

  //   for (const id of storedSelectedSongIds) {
  //     try {
  //       const response = await axios.get(
  //         getApiUrl("search", `/songs/${id}/suggestions`)
  //       );
  //       setsuggSong((prevState) => [...prevState, ...response.data.data]);
  //     } catch (error) {
  //       console.error(`Error fetching data for ID ${id}:`, error);
  //     }
  //   }
  // };

  const fetchAllSongs = async () => {
    const storedSelectedSongIds =
      JSON.parse(localStorage.getItem("selectedSongIds")) || [];
    // console.log(storedSelectedSongIds);

    // Use a Set to keep track of unique songs
    const seenSongs = new Set();

    for (const id of storedSelectedSongIds) {
      try {
        const response = await axios.get(
          getApiUrl("search", `/songs/${id}/suggestions`)
        );

        const newSongs = response.data.data.filter((song) => {
          if (seenSongs.has(song.id)) {
            return false; // Song is a duplicate
          } else {
            seenSongs.add(song.id);
            return true; // Song is unique
          }
        });

        setsuggSong((prevSuggSongs) => {
          const uniqueNewSongs = newSongs.filter(
            (newSong) => !prevSuggSongs.some((prevSong) => prevSong.id === newSong.id)
          );
          return [...prevSuggSongs, ...uniqueNewSongs];
        });
      } catch (error) {
        console.error(`Error fetching data for ID ${id}:`, error);
      }
    }
  };

  function likeset(e) {
    // console.log(e);
    var tf =
      localStorage.getItem("likeData") &&
      JSON.parse(localStorage.getItem("likeData")).some(
        (item) => item.id == e?.id
      );
    // console.log(tf);
    // console.log(e?.id);
    setlike(tf);
    // console.log(like);
  }

  function likehandle(i) {
    // Retrieve existing data from localStorage
    let existingData = localStorage.getItem("likeData");

    // Initialize an array to hold the updated data
    let updatedData = [];

    // If existing data is found, parse it from JSON
    if (existingData) {
      updatedData = JSON.parse(existingData);
    }

    // Check if the new data already exists in the existing data
    let exists = updatedData.some((item) => item.id === i.id);

    if (!exists) {
      // If not, add the new data
      updatedData.push(i);
      // Store the updated data back into localStorage
      localStorage.setItem("likeData", JSON.stringify(updatedData));
      setlike(true);
      // toast.success(`Song (${i?.name}) added to Likes section ‚úÖ`);
      toast(`Song (${i?.name}) added to Likes section`, {
        icon: "‚úÖ",
        duration: 1500,
        style: {
          borderRadius: "10px",
          background: "linear-gradient(to right, #8A2BE2, #BF40FF)",
          color: "#fff",
        },
      });
    } else {
      // setlike(true);
      // Otherwise, inform the user that the song is already liked
      // console.log("You've already liked this song.");
      // toast.error("You've already liked this song.");

      setlike(false);
      let existingData = localStorage.getItem("likeData");

      // If no data exists, there's nothing to remove
      if (!existingData) {
        console.log("No data found in localStorage.");
        return;
      }
      // Parse the existing data from JSON
      let updatedData = JSON.parse(existingData);

      // Find the index of the song with the given ID in the existing data
      const indexToRemove = updatedData.findIndex((item) => item.id === i.id);

      // If the song is found, remove it from the array
      if (indexToRemove !== -1) {
        updatedData.splice(indexToRemove, 1);

        // Store the updated data back into localStorage
        localStorage.setItem("likeData", JSON.stringify(updatedData));
        //   console.log("Song removed successfully.");
        // toast.success(`Song (${i?.name}) removed successfully. üöÆ`);
        // toast(`Song (${i?.name}) removed successfully. üöÆ`, {
        //   icon: '‚ö†Ô∏è',
        // });

        toast(`Song (${i?.name}) removed successfully.`, {
          icon: "‚ö†Ô∏è",
          duration: 1500,
          style: {
            borderRadius: "10px",
            background: "#1a1a1a",
            color: "#fff",
            border: "1px solid rgba(255,255,255,0.1)",
          },
        });

        // if (index>0 && details.length>=0) {
        //     setrerender(!rerender)
        //     var index2 = index-1
        //     setindex(index2);
        //     setsonglink([details[index2]]);
        // }
        // else{
        //     setrerender(!rerender)
        // }
      } else {
        toast.error("Song not found in localStorage.");
        //   console.log("Song not found in localStorage.");
      }
    }
  }

  // function SongLike(e) {
  //   console.log(e);
  //   // Check if the song is already liked (exists in localStorage)
  //   const isLiked = localStorage.getItem('likeData') && JSON.parse(localStorage.getItem('likeData')).some(item => item.id === e.id);
  //   console.log(isLiked);
  // }

  // const initializeMediaSession = () => {
  //   if ("mediaSession" in navigator) {
  //     navigator.mediaSession.metadata = new MediaMetadata({
  //       title: songlink[0]?.name || "",
  //       artist: songlink[0]?.album?.name || "",
  //       artwork: [
  //         {
  //           src: songlink[0]?.image[2]?.url || "",
  //           sizes: "512x512",
  //           type: "image/jpeg",
  //         },
  //       ],
  //     });

  //     navigator.mediaSession.setActionHandler("play", function () {
  //       // Handle play action
  //       if (audioRef.current) {
  //         audioRef.current.play().catch((error) => {
  //           console.error("Play error:", error);
  //         });
  //       }
  //     });

  //     navigator.mediaSession.setActionHandler("pause", function () {
  //       // Handle pause action
  //       if (audioRef.current) {
  //         audioRef.current.pause().catch((error) => {
  //           console.error("Pause error:", error);
  //         });
  //       }
  //     });

  //     navigator.mediaSession.setActionHandler("previoustrack", function () {
  //       pre();
  //     });

  //     navigator.mediaSession.setActionHandler("nexttrack", function () {
  //       next();
  //     });
  //   } else {
  //     console.warn("MediaSession API is not supported.");
  //   }
  // };
  const initializeMediaSession = () => {
    const isIOS = /(iPhone|iPod|iPad)/i.test(navigator.userAgent);

    if (!isIOS && "mediaSession" in navigator) {
      navigator.mediaSession.metadata = new MediaMetadata({
        title: songlink[0]?.name || "",
        artist: songlink[0]?.album?.name || "",
        artwork: [
          {
            src: songlink[0]?.image[2]?.url || "",
            sizes: "512x512",
            type: "image/jpeg",
          },
        ],
      });

      navigator.mediaSession.setActionHandler("play", function () {
        // Handle play action
        if (audioRef.current) {
          audioRef.current.play().catch((error) => {
            console.error("Play error:", error);
          });
        }
      });

      navigator.mediaSession.setActionHandler("pause", function () {
        // Handle pause action
        if (audioRef.current) {
          audioRef.current.pause().catch((error) => {
            console.error("Pause error:", error);
          });
        }
      });

      navigator.mediaSession.setActionHandler("previoustrack", function () {
        pre();
      });

      navigator.mediaSession.setActionHandler("nexttrack", function () {
        next();
      });
    } else {
      console.warn("MediaSession API is not supported or the device is iOS.");
    }
  };

  const initializeMediaSession2 = () => {
    const isIOS = /(iPhone|iPod|iPad)/i.test(navigator.userAgent);

    if (!isIOS && "mediaSession" in navigator) {
      navigator.mediaSession.metadata = new MediaMetadata({
        title: songlink2[0]?.name || "",
        artist: songlink2[0]?.album?.name || "",
        artwork: [
          {
            src: songlink2[0]?.image[2]?.url || "",
            sizes: "512x512",
            type: "image/jpeg",
          },
        ],
      });

      navigator.mediaSession.setActionHandler("play", function () {
        // Handle play action
        if (audioRef.current) {
          audioRef.current.play().catch((error) => {
            console.error("Play error:", error);
          });
        }
      });

      navigator.mediaSession.setActionHandler("pause", function () {
        // Handle pause action
        if (audioRef.current) {
          audioRef.current.pause().catch((error) => {
            console.error("Pause error:", error);
          });
        }
      });

      navigator.mediaSession.setActionHandler("previoustrack", function () {
        pre2();
      });

      navigator.mediaSession.setActionHandler("nexttrack", function () {
        next2();
      });
    } else {
      console.warn("MediaSession API is not supported or the device is iOS.");
    }
  };



  function next() {
    if (index < details.length - 1) {
      setindex(prev => prev + 1);
      audioseter(index + 1);
    } else {
      setindex(0);
      setsonglink([details[0]]);
    }
  }
  function next2() {
    if (index2 < suggSong.length - 1) {
      setindex2(prev => prev + 1);
      audioseter2(index2 + 1);
    } else {
      setindex2(0);
      setsonglink2([suggSong[0]]);
    }
  }

  function pre() {
    if (index > 0) {
      setindex(prev => prev - 1);
      audioseter(index - 1);
    } else {
      setindex(details.length - 1);
      setsonglink([details[details.length - 1]]);
    }
  }
  function pre2() {
    if (index2 > 0) {
      setindex2(prev => prev - 1);
      audioseter2(index2 - 1);
    } else {
      setindex2(suggSong.length - 1);
      setsonglink2([suggSong[suggSong.length - 1]]);
    }
  }

  // const handleDownloadSong = async (url, name) => {
  //   try {
  //     toast.success(`Song ${name} Downloading...`);
  //     const res = await fetch(url);
  //     const blob = await res.blob();
  //     const link = document.createElement("a");
  //     link.href = URL.createObjectURL(blob);
  //     link.download = `${name}.mp3`;

  //     document.body.appendChild(link);
  //     link.click();

  //     document.body.removeChild(link);
  //     toast.success("Song Downloaded ‚úÖ");
  //   } catch (error) {
  //     console.log("Error fetching or downloading files", error);
  //   }
  // };


  const handleDownloadSong = (url, name, poster) => {
    return toast.promise(
      new Promise(async (resolve, reject) => {
        try {
          // Display loading message
          // toast.loading(`Song ${name} Downloading...`, {
          //   id: 'loading-toast' // Set a unique ID for the loading toast
          // });

          // Perform the download
          const res = await fetch(url);
          const blob = await res.blob();
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = `${name}.mp3`;

          document.body.appendChild(link);
          link.click();

          document.body.removeChild(link);



          resolve(); // Resolve the promise once the download is complete
        } catch (error) {
          console.log("Error fetching or downloading files", error);
          reject("Error downloading song");
        }
      }),
      {
        loading: `Song ${name} Downloading...`, // Loading message
        success: `Song Downloaded ‚úÖ`, // Success message
        error: <b>Error downloading song.</b>, // Error message
      }
    );
  };

  // const handleGenerateAudio = async (data) => {
  //   try {
  //     toast.loading(`Processing your audio (${data.songName}) Please wait...`);

  //     const response = await axios.get(getApiUrl("download", "/generate-audio"), {
  //       params: data,
  //       responseType: "blob", // Important to receive the file as a blob
  //     });

  //     if (response.status === 200) {
  //       // Create a link to download the file
  //       const blob = new Blob([response.data], { type: "audio/mp3" });
  //       const downloadLink = document.createElement("a");
  //       downloadLink.href = URL.createObjectURL(blob);
  //       downloadLink.download = `${data.songName || "your_audio"}.m4a`;
  //       document.body.appendChild(downloadLink);
  //       downloadLink.click();
  //       document.body.removeChild(downloadLink);

  //       toast.dismiss(); // Dismiss the loading toast
  //       toast.success(`Your audio file (${data.songName}) is ready and downloaded!`);
  //     } else {
  //       throw new Error("Failed to generate the audio.");
  //     }
  //   } catch (error) {
  //     toast.dismiss(); // Dismiss the loading toast
  //     toast.error(
  //       "An error occurred. Please check the audio or image URLs and try again."
  //     );
  //     console.error("Error generating audio:", error);
  //   }
  // };

  function detailsseter() {
    setpage(1);
    setindex("");
    setindex2("");
    setsonglink([]);
    setsonglink2([]);
    setdetails([]);
    setsuggSong([]);
  }



  function seccall() {
    const intervalId = setInterval(() => {
      if (home === null) {
        // sethome([])
        Getartists();
      }
    }, 1000);
    return intervalId;
  }
  useEffect(() => {
    // List of languages to handle with sequential paging
    const sequentialLanguages = ["english", "tamil", "malayalam", "telugu"];

    // Increased limit for continuous playback
    if (details.length >= 0 && page < 500) {
      const timeoutId = setTimeout(() => {
        setpage2(Math.floor(Math.random() * 50));
        setpage(prev => prev + 1);

        if (sequentialLanguages.includes(language.toLowerCase())) {
          GetLanguageSongs(page + 1);
        } else {
          Getdetails();
        }
      }, page <= 2 ? 500 : 2000);
      return () => clearTimeout(timeoutId);
    }
  }, [page, language]);

  useEffect(() => {
    Gethome();
    GetFreshHits();
    GetBestOf90s();
    GetIndiaSuperhitsTop50();

    // Initial fetch for songs based on language
    const sequentialLanguages = ["english", "tamil", "malayalam", "telugu"];
    if (sequentialLanguages.includes(language.toLowerCase())) {
      GetLanguageSongs(1); // Start from page 1
    } else {
      Getdetails();
    }

  }, [language]);

  useEffect(() => {
    const interval = seccall();
    return () => clearInterval(interval);
  }, [language, home]);

  useEffect(() => {
    likeset(songlink[0]);
  }, [songlink]);

  useEffect(() => {
    likeset(songlink2[0]);
  }, [songlink2]);


  useEffect(() => {
    const isIOS = /(iPhone|iPod|iPad)/i.test(navigator.userAgent);

    if (!isIOS && songlink.length > 0) {
      audioRef.current.play();
      initializeMediaSession();
    }
  }, [songlink, initializeMediaSession]);

  useEffect(() => {
    const isIOS = /(iPhone|iPod|iPad)/i.test(navigator.userAgent);

    if (!isIOS && songlink2.length > 0) {
      audioRef.current.play();
      initializeMediaSession2();
    }
  }, [songlink2, initializeMediaSession2]);


  useEffect(() => {
    processLikedSongIds();
    // console.log('Selected Song IDs:', selectedIds);
  }, [language, processLikedSongIds]);

  // useEffect(() => {
  //   initializeMediaSession();
  // }, [songlink]);

  // useEffect(() => {
  //   Getdetails();
  //   Getartists();
  // }, [language]);

  // useEffect(() => {
  //   var interval = seccall();

  //   return () => clearInterval(interval);
  // }, [details, page, language]);

  // useEffect(() => {
  //   var interval2 = seccall2();

  //   return () => clearInterval(interval2);
  // }, [details, page, language]);

  var title = songlink[0]?.name;
  document.title = `${title ? title : "Max-Vibe"}`;
  // console.log(details);
  // console.log(home);
  // console.log(page);
  // console.log(page2);
  // console.log(songlink);
  // console.log(index)
  // console.log(suggSong);
  // console.log(songlinkchecker);

  return details.length > 0 ? (
    <div className="w-full h-screen bg-black text-white">
      <Toaster position="top-center" reverseOrder={false} />
      <motion.div
        initial={{ opacity: 0, y: -50 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ ease: Circ.easeIn, duration: 0.5 }}
        className="logo fixed flex items-center z-[99] top-0 w-full duration-200 max-h-[20vh] flex sm:block backdrop-blur-xl py-3 px-10 sm:px-5 items-center gap-3 border-b border-white/5"
      >
        <div className="flex items-center sm:justify-center sm:pt-2 gap-2 w-[-10%]">
          <img className="w-[5vw] sm:w-[10vw] rounded-full shadow-purple-glow" src={logo} alt="" />
          <h1 className="text-3xl text-white p-0 rounded-full sm:text-2xl font-bold whitespace-nowrap">MAX-VIBE</h1>
        </div>
        <motion.div
          initial={{ opacity: 0, y: -50 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ ease: Circ.easeIn, duration: 1 }}
          className="sm:pt-3 sm:ml-4 text-white ml-20 sm:justify-center"
        >
          {/* <h3 className="inline text-xl sm:hidden">Search : </h3> */}

          <Link
            className="ml-2 sm:ml-4 px-4 py-2 text-xl sm:text-sm font-bold text-white rounded-xl bg-white/5 backdrop-blur-md border border-white/10 shadow-purple-glow hover:bg-purple-gradient hover:shadow-purple-glow hover:border-white/20 transition-all duration-300 ease-out"
            to={"/songs"}
          >
            Songs
          </Link>
          <Link
            className="ml-2 sm:ml-4 px-4 py-2 text-xl sm:text-sm font-bold text-white rounded-xl bg-white/5 backdrop-blur-md border border-white/10 shadow-purple-glow hover:bg-purple-gradient hover:shadow-purple-glow hover:border-white/20 transition-all duration-300 ease-out"
            to={"/playlist"}
          >
            PlayLists
          </Link>
          <Link
            className="ml-2 sm:ml-4 px-4 py-2 text-xl sm:text-sm font-bold text-white rounded-xl bg-white/5 backdrop-blur-md border border-white/10 shadow-purple-glow hover:bg-purple-gradient hover:shadow-purple-glow hover:border-white/20 transition-all duration-300 ease-out"
            to={"/album"}
          >
            Album
          </Link>
          <Link
            className="ml-2 sm:ml-4 px-4 py-2 text-xl sm:text-sm font-bold text-white rounded-xl bg-white/5 backdrop-blur-md border border-white/10 shadow-purple-glow hover:bg-purple-gradient hover:shadow-purple-glow hover:border-white/20 transition-all duration-300 ease-out"
            to={"/artists"}
          >
            Artists
          </Link>
          <Link
            className="ml-2 sm:ml-4 px-4 py-2 text-xl sm:text-sm font-bold text-white rounded-xl bg-white/5 backdrop-blur-md border border-white/10 shadow-purple-glow hover:bg-purple-gradient hover:shadow-purple-glow hover:border-white/20 transition-all duration-300 ease-out"
            to={"/likes"}
          >
            Likes
          </Link>

        </motion.div>
        {/* <div className="w-full flex sm:justify-center items-center justify-end p-1 sm:p-2">
          <a
            target="_blank"
            href={
              "https://github.com/vkvickkey/xman"
            }
            className="ml-2 sm:ml-4 cursor-pointer  text-3xl  text-zinc-100  ri-github-fill"
          ></a>
        </div> */}
      </motion.div>
      <div className="w-full  bg-black  min-h-[40vh] pt-[20vh] pb-[15vh]  text-white p-2 flex flex-col gap-1 overflow-auto">
        <div className="w-full flex justify-end dropdown-control">
          <Dropdown
            className=" w-[100%] text-sm sm:w-[100%] mb-8 p-2 rounded-xl"
            options={options}
            onChange={(e) => {
              setlanguage(e.value);
              localStorage.setItem("language", e.value);
            }}
            placeholder={language ? ` ${language}  ` : "Select language"}
          />
        </div>



        <div className="trending songs flex flex-col gap-3 w-full ">
          <div className="relative w-full py-3 px-6 mb-2 flex items-center justify-between rounded-3xl bg-white/5 backdrop-blur-2xl border-t border-l border-r border-white/10 border-b-0 shadow-xl overflow-hidden shrink-0 group">
            {/* Ambient Bottom Glow */}
            <div className="absolute bottom-0 left-0 w-full h-[2px] bg-gradient-to-r from-[#8A2BE2] via-[#BF40FF] to-[#8A2BE2] blur-[1px] shadow-[0_0_20px_rgba(191,64,255,0.6)]"></div>

            {/* Left Icon */}
            <div className="flex items-center justify-center w-10 h-10 rounded-full bg-black/20 border border-white/5 backdrop-blur-md shadow-[inset_0_1px_4px_rgba(255,255,255,0.1)] cursor-pointer hover:bg-white/10 hover:scale-105 transition-all duration-300">
              <i className="ri-music-fill text-white text-xl"></i>
            </div>

            {/* Center Title */}
            <h3 className="text-2xl font-bold text-white/90 tracking-wide capitalize drop-shadow-lg font-sans">
              {language} Songs
            </h3>

            {/* Right Icon */}
            <div onClick={handleAiShuffle} className="flex items-center justify-center w-10 h-10 rounded-full bg-black/20 border border-white/5 backdrop-blur-md shadow-[inset_0_1px_4px_rgba(255,255,255,0.1)] cursor-pointer hover:bg-white/10 hover:scale-105 transition-all duration-300">
              <i className="ri-music-fill text-white text-xl"></i>
            </div>
          </div>
          <div className="relative group w-full">
            <ScrollButtons scrollRef={detailsRef} />
            <motion.div ref={detailsRef} className="songs custom-scrollbar px-5 sm:px-3 flex flex-shrink gap-5 overflow-x-auto w-full pb-4">
              {details?.map((t, i) => (
                <motion.div
                  //  whileHover={{  y: 0,scale: 0.9 }}
                  //  viewport={{ once: true }}
                  initial={{ y: -100, scale: 0.5 }}
                  whileInView={{ y: 0, scale: 1 }}
                  transition={{ ease: Circ.easeIn, duration: 0.05 }}
                  onClick={() => audioseter(i)}
                  key={i}
                  className="relative hover:scale-95 sm:hover:scale-105 duration-300 flex-shrink-0 w-[15%] sm:w-[40%] rounded-md flex flex-col gap-1 py-4 cursor-pointer"
                >
                  <motion.img
                    className="relative w-full  rounded-md"
                    // src={t.image[2].link}
                    src={t.image[2].url}
                    alt=""
                  />
                  <div className="flex  items-center ">
                    <p className=" font-bold text-transparent bg-clip-text bg-gradient-to-r from-p-violet to-p-magenta">{i + 1}</p>
                  </div>

                  <img
                    className={`absolute top-4 w-[20%] sm:w-[25%] rounded-md ${i === index ? "block" : "hidden"
                      } `}
                    src={wavs}
                    alt=""
                  />
                  {songlink.length > 0 && (
                    <i className={`absolute top-20 sm:top-16 w-full  flex items-center justify-center text-5xl text-p-magenta drop-shadow-[0_0_15px_rgba(191,64,255,0.8)] opacity-90  duration-300 rounded-md  ${t.id === songlink[0]?.id ? "block" : "hidden"
                      } ${audiocheck
                        ? "ri-pause-circle-fill"
                        : "ri-play-circle-fill"
                      }`}
                    ></i>
                  )}

                  <motion.div
                    className="flex flex-col"
                  >
                    <h3
                      className={`text-sm sm:text-xs leading-none font-bold ${i === index ? "text-p-magenta shadow-purple-glow" : "text-white"
                        }`}
                    >
                      {removeSourceAttribution(t.name)}
                    </h3>
                    <h4 className="text-xs sm:text-[2.5vw] text-white/60">
                      {removeSourceAttribution(t.album.name)}
                    </h4>
                    <div className="flex flex-col mt-1">
                      <span className="text-[10px] sm:text-[8px] text-zinc-400">
                        {getArtistMetadata(t.artists).singleLine}
                      </span>
                    </div>
                  </motion.div>
                </motion.div>
              ))}

              <img
                className={page >= 18 ? "hidden" : "w-[20%] h-[20%]"}
                src={wait}
              />
            </motion.div>
          </div>
        </div>
        {suggSong.length > 0 && (
          <div className="trending songs flex flex-col gap-3 w-full ">
            <div className="relative w-full py-3 px-6 mb-2 flex items-center justify-between rounded-3xl bg-white/5 backdrop-blur-2xl border-t border-l border-r border-white/10 border-b-0 shadow-xl overflow-hidden shrink-0 group">
              {/* Ambient Bottom Glow */}
              <div className="absolute bottom-0 left-0 w-full h-[2px] bg-gradient-to-r from-[#8A2BE2] via-[#BF40FF] to-[#8A2BE2] blur-[1px] shadow-[0_0_20px_rgba(191,64,255,0.6)]"></div>

              {/* Left Icon */}
              <div className="flex items-center justify-center w-10 h-10 rounded-full bg-black/20 border border-white/5 backdrop-blur-md shadow-[inset_0_1px_4px_rgba(255,255,255,0.1)] cursor-pointer hover:bg-white/10 hover:scale-105 transition-all duration-300">
                <i className="ri-music-fill text-white text-xl"></i>
              </div>

              {/* Center Title */}
              <h3 className="text-2xl font-bold text-white/90 tracking-wide capitalize drop-shadow-lg font-sans flex flex-col items-center">
                Songs for you
                <span className="text-xs text-white/50 font-normal normal-case tracking-normal mt-1">
                  (based on your liked songs)
                </span>
              </h3>

              {/* Right Icon */}
              <div onClick={refreshSuggestions} className="flex items-center justify-center w-10 h-10 rounded-full bg-black/20 border border-white/5 backdrop-blur-md shadow-[inset_0_1px_4px_rgba(255,255,255,0.1)] cursor-pointer hover:bg-white/10 hover:scale-105 transition-all duration-300">
                <i className="ri-music-fill text-white text-xl"></i>
              </div>
            </div>
            <div className="relative group w-full">
              <ScrollButtons scrollRef={suggRef} />
              <motion.div ref={suggRef} className="songs custom-scrollbar px-5 sm:px-3 flex flex-shrink gap-5 overflow-x-auto w-full pb-4">
                {suggSong?.map((t, i) => (
                  <motion.div
                    //  whileHover={{  y: 0,scale: 0.9 }}
                    //  viewport={{ once: true }}
                    initial={{ y: -100, scale: 0.5 }}
                    whileInView={{ y: 0, scale: 1 }}
                    transition={{ ease: Circ.easeIn, duration: 0.05 }}
                    onClick={() => audioseter2(i)}
                    key={i}
                    className="relative hover:scale-95 sm:hover:scale-105 duration-300 flex-shrink-0 w-[15%] sm:w-[40%] rounded-md flex flex-col gap-1 py-4 cursor-pointer"
                  >
                    <motion.img
                      className="relative w-full  rounded-md"
                      // src={t.image[2].link}
                      src={t.image[2].url}
                      alt=""
                    />
                    <div className="flex  items-center ">
                      <p className=" font-bold text-transparent bg-clip-text bg-gradient-to-r from-p-violet to-p-magenta">{i + 1}</p>
                    </div>

                    <img
                      className={`absolute top-4 w-[20%] sm:w-[25%] rounded-md ${i === index2 ? "block" : "hidden"
                        } `}
                      src={wavs}
                      alt=""
                    />
                    {songlink2.length > 0 && (
                      <i className={`absolute top-20 sm:top-16 w-full  flex items-center justify-center text-5xl text-p-magenta drop-shadow-[0_0_15px_rgba(191,64,255,0.8)] opacity-90  duration-300 rounded-md  ${t.id === songlink2[0]?.id ? "block" : "hidden"
                        } ${audiocheck
                          ? "ri-pause-circle-fill"
                          : "ri-play-circle-fill"
                        }`}
                      ></i>
                    )}

                    <motion.div
                      className="flex flex-col"
                    >
                      <h3
                        className={`text-sm sm:text-xs leading-none font-bold ${t.id === songlink2[0]?.id ? "text-p-magenta shadow-purple-glow" : "text-white"
                          }`}
                      >
                        {removeSourceAttribution(t.name)}
                      </h3>
                      <h4 className="text-xs sm:text-[2.5vw] text-white/70">
                        {t.album.name}
                      </h4>
                      <div className="flex flex-col mt-1">
                        <span className="text-[10px] sm:text-[8px] text-zinc-400">
                          {getArtistMetadata(t.artists).singleLine}
                        </span>
                      </div>
                    </motion.div>
                  </motion.div>
                ))}
              </motion.div>
            </div>
          </div>
        )}


        {/* <div className="trending flex flex-col gap-3 w-full ">
          <h3 className="text-xl h-[5vh] font-semibold">Trending Albums</h3>
          <div className="playlistsdata px-5 sm:px-3 flex flex-shrink  gap-5 overflow-x-auto overflow-hidden w-full ">
            {home?.trending?.albums.map((t, i) => (
              <Link
                to={`/albums/details/${t.id}`}
                key={i}
                className="hover:scale-110 sm:hover:scale-100  duration-150 flex-shrink-0 w-[15%] sm:w-[40%] rounded-md flex flex-col gap-2 py-4"
              >
                <img
                  className="w-full  rounded-md"
                  src={t.image[2].link}
                  alt=""
                />
                
                <h3 className="leading-none ">{t.name}</h3>
              
              </Link>
            ))}
          </div>
        </div>  */}
        <div className="charts w-full flex flex-col gap-3   ">
          <div className="relative w-full py-3 px-6 mb-2 flex items-center justify-between rounded-3xl bg-white/5 backdrop-blur-2xl border-t border-l border-r border-white/10 border-b-0 shadow-xl overflow-hidden shrink-0 group">
            {/* Ambient Bottom Glow */}
            <div className="absolute bottom-0 left-0 w-full h-[2px] bg-gradient-to-r from-[#8A2BE2] via-[#BF40FF] to-[#8A2BE2] blur-[1px] shadow-[0_0_20px_rgba(191,64,255,0.6)]"></div>

            {/* Left Icon */}
            <div className="flex items-center justify-center w-10 h-10 rounded-full bg-black/20 border border-white/5 backdrop-blur-md shadow-[inset_0_1px_4px_rgba(255,255,255,0.1)] cursor-pointer hover:bg-white/10 hover:scale-105 transition-all duration-300">
              <i className="ri-music-fill text-white text-xl"></i>
            </div>

            {/* Center Title */}
            <h3 className="text-2xl font-bold text-white/90 tracking-wide capitalize drop-shadow-lg font-sans">
              Charts
            </h3>

            {/* Right Icon */}
            <div onClick={refreshHomeData} className="flex items-center justify-center w-10 h-10 rounded-full bg-black/20 border border-white/5 backdrop-blur-md shadow-[inset_0_1px_4px_rgba(255,255,255,0.1)] cursor-pointer hover:bg-white/10 hover:scale-105 transition-all duration-300">
              <i className="ri-music-fill text-white text-xl"></i>
            </div>
          </div>
          <div className="relative group w-full">
            <ScrollButtons scrollRef={chartsRef} />
            <div ref={chartsRef} className="chartsdata custom-scrollbar px-5 sm:px-3 flex flex-shrink gap-5 overflow-x-auto w-full pb-4">
              {home?.charts?.map((c, i) => (
                <motion.div
                  initial={{ y: -100, scale: 0.5 }}
                  whileInView={{ y: 0, scale: 1 }}
                  transition={{ ease: Circ.easeIn, duration: 0.05 }}
                  // onClick={`/playlist/details/${c.id}`}
                  onClick={() => navigate(`/playlist/details/${c.id}`)}
                  key={i}
                  className="hover:scale-110 sm:hover:scale-105  duration-300 flex-shrink-0 w-[15%] sm:w-[40%] rounded-md flex flex-col gap-2 py-4 cursor-pointer"
                >
                  <img
                    className="w-full  rounded-md"
                    src={c.image[2].link}
                    alt=""
                  />
                  <motion.h3
                    // initial={{ y: 50, opacity: 0 }}
                    // whileInView={{ y: 0, opacity: 1 }}
                    // transition={{ease:Circ.easeIn,duration:0.05}}
                    className="leading-none"
                  >
                    {c.title}
                  </motion.h3>
                </motion.div>
              ))}
            </div>
          </div>
        </div>
        <div className="playlists w-full  flex flex-col gap-3 ">
          <div className="relative w-full py-3 px-6 mb-2 flex items-center justify-between rounded-3xl bg-white/5 backdrop-blur-2xl border-t border-l border-r border-white/10 border-b-0 shadow-xl overflow-hidden shrink-0 group">
            {/* Ambient Bottom Glow */}
            <div className="absolute bottom-0 left-0 w-full h-[2px] bg-gradient-to-r from-[#8A2BE2] via-[#BF40FF] to-[#8A2BE2] blur-[1px] shadow-[0_0_20px_rgba(191,64,255,0.6)]"></div>

            {/* Left Icon */}
            <div className="flex items-center justify-center w-10 h-10 rounded-full bg-black/20 border border-white/5 backdrop-blur-md shadow-[inset_0_1px_4px_rgba(255,255,255,0.1)] cursor-pointer hover:bg-white/10 hover:scale-105 transition-all duration-300">
              <i className="ri-music-fill text-white text-xl"></i>
            </div>

            {/* Center Title */}
            <h3 className="text-2xl font-bold text-white/90 tracking-wide capitalize drop-shadow-lg font-sans">
              Playlists
            </h3>

            {/* Right Icon */}
            <div onClick={refreshHomeData} className="flex items-center justify-center w-10 h-10 rounded-full bg-black/20 border border-white/5 backdrop-blur-md shadow-[inset_0_1px_4px_rgba(255,255,255,0.1)] cursor-pointer hover:bg-white/10 hover:scale-105 transition-all duration-300">
              <i className="ri-music-fill text-white text-xl"></i>
            </div>
          </div>
          <div className="relative group w-full">
            <ScrollButtons scrollRef={playlistsRef} />
            <div ref={playlistsRef} className="playlistsdata custom-scrollbar px-5 sm:px-3 flex flex-shrink gap-5 overflow-x-auto w-full pb-4">
              {home?.playlists?.map((p, i) => (
                <motion.div
                  initial={{ y: -100, scale: 0.5 }}
                  whileInView={{ y: 0, scale: 1 }}
                  transition={{ ease: Circ.easeIn, duration: 0.05 }}
                  // to={`/playlist/details/${p.id}`}
                  onClick={() => navigate(`/playlist/details/${p.id}`)}
                  key={i}
                  className="hover:scale-110  sm:hover:scale-105 duration-300 flex-shrink-0 w-[15%] sm:w-[40%] rounded-md  flex flex-col gap-2 py-4 cursor-pointer"
                >
                  <img
                    className="w-full  rounded-md"
                    src={p.image[2].link}
                    alt=""
                  />
                  <motion.h3
                    // initial={{ y: 50, opacity: 0 }}
                    // whileInView={{ y: 0, opacity: 1 }}
                    // transition={{ease:Circ.easeIn,duration:0.05}}
                    className="leading-none"
                  >
                    {p.title}
                  </motion.h3>
                </motion.div>
              ))}
            </div>
          </div>
        </div>
        <div className="albums w-full flex flex-col gap-3 ">
          <div className="relative w-full py-3 px-6 mb-2 flex items-center justify-between rounded-3xl bg-white/5 backdrop-blur-2xl border-t border-l border-r border-white/10 border-b-0 shadow-xl overflow-hidden shrink-0 group">
            {/* Ambient Bottom Glow */}
            <div className="absolute bottom-0 left-0 w-full h-[2px] bg-gradient-to-r from-[#8A2BE2] via-[#BF40FF] to-[#8A2BE2] blur-[1px] shadow-[0_0_20px_rgba(191,64,255,0.6)]"></div>

            {/* Left Icon */}
            <div className="flex items-center justify-center w-10 h-10 rounded-full bg-black/20 border border-white/5 backdrop-blur-md shadow-[inset_0_1px_4px_rgba(255,255,255,0.1)] cursor-pointer hover:bg-white/10 hover:scale-105 transition-all duration-300">
              <i className="ri-music-fill text-white text-xl"></i>
            </div>

            {/* Center Title */}
            <h3 className="text-2xl font-bold text-white/90 tracking-wide capitalize drop-shadow-lg font-sans">
              Albums
            </h3>

            {/* Right Icon */}
            <div onClick={refreshHomeData} className="flex items-center justify-center w-10 h-10 rounded-full bg-black/20 border border-white/5 backdrop-blur-md shadow-[inset_0_1px_4px_rgba(255,255,255,0.1)] cursor-pointer hover:bg-white/10 hover:scale-105 transition-all duration-300">
              <i className="ri-music-fill text-white text-xl"></i>
            </div>
          </div>
          <div className="relative group w-full">
            <ScrollButtons scrollRef={albumsRef} />
            <div ref={albumsRef} className="albumsdata custom-scrollbar px-5 sm:px-3 flex flex-shrink gap-5 overflow-x-auto w-full pb-4">
              {home?.albums?.map((a, i) => (
                <motion.div
                  initial={{ y: -100, scale: 0.5 }}
                  whileInView={{ y: 0, scale: 1 }}
                  transition={{ ease: Circ.easeIn, duration: 0.05 }}
                  // to={`/albums/details/${a.id}`}
                  onClick={() => navigate(`/albums/details/${a.id}`)}
                  key={i}
                  className="hover:scale-110 sm:hover:scale-105  duration-300 flex-shrink-0 w-[15%] sm:w-[40%] rounded-md  flex flex-col gap-2 py-4 cursor-pointer"
                >
                  <img
                    className="w-full  rounded-md"
                    src={a.image[2].link}
                    alt=""
                  />
                  <motion.h3
                    // initial={{ y: 50, opacity: 0 }}
                    // whileInView={{ y: 0, opacity: 1 }}
                    // transition={{ease:Circ.easeIn,duration:0.05}}
                    className="leading-none"
                  >
                    {removeSourceAttribution(a.name)}
                  </motion.h3>
                </motion.div>
              ))}
            </div>
          </div>
        </div>

        {indiaSuperhitsTop50.length > 0 && (
          <div className="india-superhits-top-50 w-full flex flex-col gap-3 ">
            <div className="relative w-full py-3 px-6 mb-2 flex items-center justify-between rounded-3xl bg-white/5 backdrop-blur-2xl border-t border-l border-r border-white/10 border-b-0 shadow-xl overflow-hidden shrink-0 group">
              <div className="absolute bottom-0 left-0 w-full h-[2px] bg-gradient-to-r from-[#8A2BE2] via-[#BF40FF] to-[#8A2BE2] blur-[1px] shadow-[0_0_20px_rgba(191,64,255,0.6)]"></div>
              <div className="flex items-center justify-center w-10 h-10 rounded-full bg-black/20 border border-white/5 backdrop-blur-md shadow-[inset_0_1px_4px_rgba(255,255,255,0.1)] cursor-pointer hover:bg-white/10 hover:scale-105 transition-all duration-300">
                <i className="ri-music-fill text-white text-xl"></i>
              </div>
              <h3 className="text-2xl font-bold text-white/90 tracking-wide capitalize drop-shadow-lg font-sans">
                India Superhits Top 50
              </h3>
              <div onClick={GetIndiaSuperhitsTop50} className="flex items-center justify-center w-10 h-10 rounded-full bg-black/20 border border-white/5 backdrop-blur-md shadow-[inset_0_1px_4px_rgba(255,255,255,0.1)] cursor-pointer hover:bg-white/10 hover:scale-105 transition-all duration-300">
                <i className="ri-refresh-line text-white text-xl"></i>
              </div>
            </div>
            <div className="relative group w-full">
              <ScrollButtons scrollRef={indiaSuperhitsTop50Ref} />
              <div ref={indiaSuperhitsTop50Ref} className="indiasuperhitstop50data custom-scrollbar px-5 sm:px-3 flex flex-shrink gap-5 overflow-x-auto w-full pb-4">
                {indiaSuperhitsTop50?.map((f, i) => (
                  <motion.div
                    initial={{ y: -100, scale: 0.5 }}
                    whileInView={{ y: 0, scale: 1 }}
                    transition={{ ease: Circ.easeIn, duration: 0.05 }}
                    onClick={() => navigate(`/playlist/details/${f.id}`)}
                    key={i}
                    className="hover:scale-110 sm:hover:scale-105 duration-300 flex-shrink-0 w-[15%] sm:w-[40%] rounded-md flex flex-col gap-2 py-4 cursor-pointer"
                  >
                    <img
                      className="w-full rounded-md"
                      src={f.image?.[2]?.link || f.image?.[2]?.url || f.image?.[0]?.link || f.image?.[0]?.url}
                      alt=""
                    />
                    <motion.h3 className="leading-none">
                      {removeSourceAttribution(f.name)}
                    </motion.h3>
                  </motion.div>
                ))}
              </div>
            </div>
          </div>
        )}
        {freshHitsData.length > 0 && (
          <FreshHitRow
            key="fresh-hits"
            language="All" // Not used for title anymore but might be needed for prop types if strictly typed (not here)
            data={freshHitsData}
            navigate={navigate}
            onRefresh={() => GetFreshHits()}
          />
        )}
        {bestOf90s.length > 0 && (
          <div className="best-of-90s w-full flex flex-col gap-3 ">
            <div className="relative w-full py-3 px-6 mb-2 flex items-center justify-between rounded-3xl bg-white/5 backdrop-blur-2xl border-t border-l border-r border-white/10 border-b-0 shadow-xl overflow-hidden shrink-0 group">
              <div className="absolute bottom-0 left-0 w-full h-[2px] bg-gradient-to-r from-[#8A2BE2] via-[#BF40FF] to-[#8A2BE2] blur-[1px] shadow-[0_0_20px_rgba(191,64,255,0.6)]"></div>
              <div className="flex items-center justify-center w-10 h-10 rounded-full bg-black/20 border border-white/5 backdrop-blur-md shadow-[inset_0_1px_4px_rgba(255,255,255,0.1)] cursor-pointer hover:bg-white/10 hover:scale-105 transition-all duration-300">
                <i className="ri-music-fill text-white text-xl"></i>
              </div>
              <h3 className="text-2xl font-bold text-white/90 tracking-wide capitalize drop-shadow-lg font-sans">
                Best Of 90s
              </h3>
              <div onClick={GetBestOf90s} className="flex items-center justify-center w-10 h-10 rounded-full bg-black/20 border border-white/5 backdrop-blur-md shadow-[inset_0_1px_4px_rgba(255,255,255,0.1)] cursor-pointer hover:bg-white/10 hover:scale-105 transition-all duration-300">
                <i className="ri-refresh-line text-white text-xl"></i>
              </div>
            </div>
            <div className="relative group w-full">
              <ScrollButtons scrollRef={bestOf90sRef} />
              <div ref={bestOf90sRef} className="bestof90sdata custom-scrollbar px-5 sm:px-3 flex flex-shrink gap-5 overflow-x-auto w-full pb-4">
                {bestOf90s?.map((f, i) => (
                  <motion.div
                    initial={{ y: -100, scale: 0.5 }}
                    whileInView={{ y: 0, scale: 1 }}
                    transition={{ ease: Circ.easeIn, duration: 0.05 }}
                    onClick={() => navigate(`/playlist/details/${f.id}`)}
                    key={i}
                    className="hover:scale-110 sm:hover:scale-105 duration-300 flex-shrink-0 w-[15%] sm:w-[40%] rounded-md flex flex-col gap-2 py-4 cursor-pointer"
                  >
                    <img
                      className="w-full rounded-md"
                      src={f.image?.[2]?.link || f.image?.[2]?.url || f.image?.[0]?.link || f.image?.[0]?.url}
                      alt=""
                    />
                    <motion.h3 className="leading-none">
                      {removeSourceAttribution(f.name)}
                    </motion.h3>
                  </motion.div>
                ))}
              </div>
            </div>
          </div>
        )}




        <div>
          <p className="font-semibold text-white/50 sm:text-sm">
            <b></b>
          </p>
        </div>
      </div >

      <motion.div
        className={
          (songlink.length > 0 || songlink2.length > 0)
            ? `duration-700 fixed z-[99] bottom-0 flex gap-3 items-center w-full py-3 backdrop-blur-xl`
            : "hidden"
        }
      >
        {(() => {
          let activeLink = [];
          let activeIndex = 0;
          let handleNext = next;
          let handlePre = pre;

          if (songlink.length > 0) {
            activeLink = songlink;
            activeIndex = index;
            handleNext = next;
            handlePre = pre;
          } else if (songlink2.length > 0) {
            activeLink = songlink2;
            activeIndex = index2;
            handleNext = next2;
            handlePre = pre2;
          }

          return activeLink?.map((e, i) => (
            <motion.div
              initial={{ y: 100, opacity: 0, scale: 0 }}
              animate={{ y: 0, opacity: 1, scale: 1 }}
              transition={{ ease: Circ.easeIn, duration: 0.7 }}
              key={i}
              className={`flex sm:block w-full sm:w-full sm:h-full items-center justify-center gap-3`}
            >
              <motion.div
                initial={{ x: -100, opacity: 0, scale: 0 }}
                animate={{ x: 0, opacity: 1, scale: 1 }}
                className="w-[25vw] sm:w-full flex gap-3 items-center sm:justify-center rounded-md h-[7vw] sm:h-[30vw]"
              >
                <p className="font-bold text-transparent bg-clip-text bg-gradient-to-r from-p-violet to-p-magenta">{activeIndex + 1}</p>
                <motion.img
                  initial={{ x: -100, opacity: 0, scale: 0 }}
                  animate={{ x: 0, opacity: 1, scale: 1 }}
                  className={`rounded-md h-[7vw] sm:h-[25vw]`}
                  src={e?.image[2]?.url}
                  alt=""
                />

                <div className="flex flex-col">
                  <h3 className="sm:w-[30%] text-white text-xs font-semibold">
                    {removeSourceAttribution(e?.name)}
                  </h3>
                  <div className="flex flex-col">
                    <span className="text-[10px] sm:text-[8px] text-zinc-400">
                      {getArtistMetadata(e?.artists).singleLine}
                    </span>
                  </div>
                </div>
                <i
                  onClick={() => likehandle(e)}
                  className={`text-xl hover:scale-150 sm:hover:scale-100 duration-300 cursor-pointer ${like ? "text-p-magenta drop-shadow-[0_0_10px_rgba(191,64,255,0.8)]" : "text-white"} ri-heart-3-fill`}
                ></i>
              </motion.div>
              <motion.div
                initial={{ y: 100, opacity: 0, scale: 0 }}
                animate={{ y: 0, opacity: 1, scale: 1 }}
                className="w-[35%] sm:w-full h-[10vh] flex gap-3 sm:gap-1 items-center justify-center"
              >
                <button
                  onClick={handlePre}
                  className="text-3xl text-white bg-white/10 hover:bg-white/20 border border-white/5 cursor-pointer rounded-full"
                >
                  <i className="ri-skip-back-mini-fill"></i>
                </button>
                <audio
                  ref={audioRef}
                  onPause={() => setaudiocheck(false)}
                  onPlay={() => setaudiocheck(true)}
                  className="w-[80%]"
                  controls
                  autoPlay
                  onEnded={handleNext}
                  src={e?.downloadUrl[4]?.url}
                ></audio>
                <button
                  onClick={handleNext}
                  className="text-3xl text-white bg-white/10 hover:bg-white/20 border border-white/5 cursor-pointer rounded-full"
                >
                  <i className="ri-skip-right-fill"></i>
                </button>
              </motion.div>
              <div className="flex flex-col text-[1vw] items-center gap-2">
                <div>
                  <h3 className="font-bold text-sm text-white/70">
                    Download Options
                  </h3>
                </div>
                <div className="flex flex-row-reverse gap-2 ">
                  <p
                    onClick={() =>
                      handleGenerateAudio2({
                        audioUrl: e?.downloadUrl[4].url,
                        imageUrl: e?.image[2]?.url,
                        songName: e?.name,
                        year: e?.year,
                        album: e?.album.name,
                        artist: e?.artists.primary.map(artist => artist.name).join(",")
                      })
                    }
                    className="duration-300 cursor-pointer hover:text-white hover:bg-white/20 hover:scale-90 w-fit p-1 sm:text-sm font-semibold rounded-md shadow-2xl bg-white/10 border border-white/10 flex flex-col items-center"
                  >
                    Highest quality with <br />
                    <p className="text-xs text-center">FLAC Format</p>
                  </p>
                  <p
                    onClick={() =>
                      handleGenerateAudio({
                        audioUrl: e?.downloadUrl[4].url,
                        imageUrl: e?.image[2]?.url,
                        songName: removeSourceAttribution(e?.name),
                        year: e?.year,
                        album: getAlbumFromTitle(e?.name) || removeSourceAttribution(e?.album?.name),
                        artist: e?.artists?.primary?.map(artist => artist.name).join(",")
                      })
                    }
                    className="duration-300 cursor-pointer hover:text-white hover:bg-white/20 hover:scale-90 w-fit p-1 sm:text-sm font-semibold rounded-md shadow-2xl bg-white/10 border border-white/10 flex flex-col items-center"
                  >
                    320kbps<br />
                    <p className="text-xs text-center">High quality with poster embedded
                      <br /></p>
                  </p>
                </div>
              </div>
            </motion.div>
          ));
        })()}
      </motion.div>

    </div >
  ) : (
    <Loading />
  );
};

export default Home;
